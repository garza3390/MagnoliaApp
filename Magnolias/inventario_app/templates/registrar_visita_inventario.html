{% extends "base.html" %}

{% block title %}Registrar Visita de Inventario{% endblock %}
{% block content %}
<style>
    .info-container {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .info-container p {
        margin: 10px 0;
        font-size: 16px;
    }

    .info-container strong {
        color: #343a40;
    }

    .form-group label {
        font-weight: bold;
        margin-top: 10px;
    }

    .form-group input {
        margin-bottom: 10px;
    }

    @media (max-width: 768px) {
        .info-container p {
            font-size: 14px;
        }
        
        .btn {
            font-size: 16px;
        }
    }

    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }

    .table {
        width: 100%;
        table-layout: auto;
    }

    .table th, .table td {
        min-width: 80px;
        max-width: 120px;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: normal;
    }

    .table th {
        color: rgb(0, 0, 0);
        background-color: rgba(106, 169, 236, 0.5);
        font-weight: bold;
        word-break: break-all;
        padding: 10px;
    }

    .table input.form-control {
        width: 100%;
        box-sizing: border-box;
        min-width: 90px;
    }
</style>

<div class="info-container">
    <h2 class="text-center">Registro de Visita de Inventario</h2>
    <p><strong>Tienda:</strong> {{ tienda.nombre_tienda }} ({{ tienda.codigo_tienda }})</p>
    <p><strong>Semana:</strong> {{ semana_actual }}</p>
    <p><strong>Código de Tienda:</strong> {{ tienda.codigo_tienda }}</p>
    <p><strong>Fecha entrega anterior:</strong> {{ fecha_visita_anterior|date:"d/M/Y" }}</p>
    <p><strong>Fecha actual:</strong> {{ fecha_actual|date:"d/M/Y" }}</p>
    <p><strong>Fecha Proxima visita:</strong> {{ proxima_visita|date:"d/M/Y" }}</p>
    <p name="dvisitas"><strong>Días entre visitas:</strong> {{ dias_entre_visitas }}</p>
    <p><strong>Días de cobertura:</strong> {{ dias_de_cobertura }}</p>
</div>

<form method="post">
    {% csrf_token %}
    <div class="table-container">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Producto ID</th>
                    <th>Nombre Producto</th>
                    <th>Inventario inicial</th>
                    <th>Existencia AM_PM</th>
                    <th>Conteo físico</th>
                    <th>Cantidad por vencer</th>
                    <th>Devolución</th>
                    <th>Canje</th>
                    <th>Ajuste</th>
                    <th>Inventario AM_PM</th>
                    <th>Sugerido AM_PM</th>
                    <th>Mínimo display</th>
                    <th>Recomendado por Magnolias</th>
                    <th>Entrega Real</th>
                </tr>
            </thead>
            <tbody>
                {% if primera_vez %}
                {% for producto in productos %}
                <tr data-precio="{{ producto.valor_con_iva }}">
                    <td>{{ producto.codigo_producto }}</td>
                    <td>{{ producto.nombre_producto }}</td>
                    <td>
                        <input type="number" name="inventario_inicial_{{ producto.id }}" class="form-control" 
                               value="{{ 0 }}"
                               {% if not primera_vez %}readonly{% endif %}>
                    </td>
                    <td><input type="number" name="existencia_ampm_{{ producto.id }}" class="form-control existencia-ampm" value=0></td>
                    <td><input type="number" name="conteo_fisico_{{ producto.id }}" class="form-control conteo-fisico" value=0></td>
                    <td><input type="number" name="por_vencer_{{ producto.id }}" class="form-control" value=0></td>
                    <td><input type="number" name="devolucion_{{ producto.id }}" class="form-control" value=0></td>
                    <td><input type="number" name="canje_{{ producto.id }}" class="form-control" value=0></td>
                    <td>
                        <input type="number" name="ajuste_{{ producto.id }}" class="form-control" value=0>
                    </td>
                    <td><input type="number" name="inventario_ampm_{{ producto.id }}" class="form-control inventario-ampm" value=0></td>
                    <td><input type="number" name="sugerido_ampm_{{ producto.id }}" class="form-control sugerido-ampm" value=0></td>
                    <td><input type="number" name="minimo_display_{{ producto.id }}" class="form-control" value=0></td>
                    <td><input type="number" name="recomendado_M_{{ producto.id }}" class="form-control" value=0></td>
                    <td><input type="number" name="entregado_real_{{ producto.id }}" class="form-control" value=0></td>
                </tr>
                {% endfor %}
                {% else %}
                {% for p,invi,e_ampm,cf,pven,dev,canj,aj,i_ampm,s_ampm,md,m_rec,e_real in all_data %}
                <tr data-precio="{{ p.valor_con_iva }}">
                    <td>{{ p.codigo_producto }}</td>
                    <td>{{ p.nombre_producto }}</td>
                    <td>
                        <input type="number" name="inventario_inicial_{{ p.id }}" class="form-control" 
                               value="{{ invi }}"
                               {% if not primera_vez %}readonly{% endif %}>
                    </td>
                    <td><input type="number" name="existencia_ampm_{{ p.id }}" class="form-control existencia-ampm" value={{e_ampm}}></td>
                    <td><input type="number" name="conteo_fisico_{{ p.id }}" class="form-control conteo-fisico" value={{cf}}></td>
                    <td><input type="number" name="por_vencer_{{ p.id }}" class="form-control" value={{pven}}></td>
                    <td><input type="number" name="devolucion_{{ p.id }}" class="form-control" value={{dev}}></td>
                    <td><input type="number" name="canje_{{ p.id }}" class="form-control" value={{canj}}></td>
                    <td>
                        <input type="number" name="ajuste_{{ p.id }}" class="form-control" value="{{ aj }}" readonly>
                    </td>
                    <td><input type="number" name="inventario_ampm_{{ p.id }}" class="form-control inventario-ampm" value={{i_ampm}}></td>
                    <td><input type="number" name="sugerido_ampm_{{ p.id }}" class="form-control sugerido-ampm" value={{s_ampm}}></td>
                    <td><input type="number" name="minimo_display_{{ p.id }}" class="form-control" value={{md}}></td>
                    <td><input type="number" name="recomendado_M_{{ p.id }}" class="form-control" value={{m_rec}} readonly></td>
                    <td><input type="number" name="entregado_real_{{ p.id }}" class="form-control" value=0></td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Venta Total calculada con JavaScript -->
    <!-- Sección de totales y opciones -->
    <div class="totals-container mt-4 p-3 bg-light rounded shadow-sm">
        <div class="form-group mb-3">
            <label for="venta_total" class="font-weight-bold">Venta Total:</label>
            <input type="text" id="venta_total" class="form-control" readonly style="background-color: #f1f1f1;">
        </div>
        <div class="form-group mb-3">
            <label for="devolucion_total" class="font-weight-bold">Devolución Total:</label>
            <input type="text" id="devolucion_total" class="form-control" readonly style="background-color: #f1f1f1;">
        </div>
    </div>

    <!-- Sección de opciones adicionales -->
    <div class="options-container mt-3 p-3 bg-light rounded shadow-sm">
        <div class="form-group mb-3">
            <div class="custom-control custom-checkbox">
                <input type="checkbox" class="custom-control-input" id="registro_bloqueado" name="registro_bloqueado" 
                    {% if rb %}checked{% endif %}>
                <label class="custom-control-label" for="registro_bloqueado">Bloquear registro</label>
            </div>
        </div>
    </div>

    <!-- Botón de envío -->
    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary btn-lg">Guardar Visita de Inventario</button>
    </div>

</form>

<a href="{% url 'seleccionar_tienda' %}" class="btn btn-secondary btn-block mt-2">Volver al Inicio</a>

<script>
    function calculateFields() {
        let diasDeCobertura = 21;

        document.querySelectorAll("tbody tr").forEach(function (row, idx) {
            let conteoFisico = parseInt(row.querySelector("input[name^='conteo_fisico']").value) || 0;
            let porVencer = parseInt(row.querySelector("input[name^='por_vencer']").value) || 0;
            let devolucion = parseInt(row.querySelector("input[name^='devolucion']").value) || 0;
            let canje = parseInt(row.querySelector("input[name^='canje']").value) || 0;
            let inventarioAMPM = parseInt(row.querySelector("input[name^='inventario_ampm']").value) || 0;
            let minimoDisplay = parseInt(row.querySelector("input[name^='minimo_display']").value) || 0;
            let inventarioInicial = parseInt(row.querySelector("input[name^='inventario_inicial']").value) || 0;

            let diasEntreVisitas = {{ dias_entre_visitas|default:0 }};

            let ajuste = conteoFisico + porVencer + devolucion + canje - inventarioAMPM;
            let ajusteInput = row.querySelector("input[name^='ajuste']");
            if (ajusteInput) {
                ajusteInput.value = ajuste;
            }

            let venta = inventarioInicial - conteoFisico - porVencer - canje - devolucion;
            let promedioDiarioVenta = (diasEntreVisitas > 0) ? venta / diasEntreVisitas : 0;
            let ventaEstimada = promedioDiarioVenta * diasDeCobertura;
            let vari = Math.max(ventaEstimada, minimoDisplay) - conteoFisico - porVencer;
            let cantidadEntregar = Math.max(vari + Math.round(porVencer * 0.5), Math.round(porVencer * 0.5));
            let recomendadoMagnolia = vari;

            let recomendadoInput = row.querySelector("input[name^='recomendado_M']");
            if (recomendadoInput) {
                recomendadoInput.value = Math.round(recomendadoMagnolia);
            }

            // let entregadoRealInput = row.querySelector("input[name^='entregado_real']");
            // if (entregadoRealInput && !entregadoRealInput.dataset.calculado) {
            //     entregadoRealInput.value = Math.round(cantidadEntregar);
            //     entregadoRealInput.dataset.calculado = true;
            // }
        });

        let t = 0;
        let d = 0;

        var devolucionInputs = document.querySelectorAll("input[name^='devolucion_']");
        var entregadoInputs = document.querySelectorAll("input[name^='entregado_real_']");
        {% if precios_productos %}
        var precios = JSON.parse('{{ precios_productos|safe|escapejs }}');
        {% else %}
        var precios = [1140.0, 1785.0, 2510.0, 730.0, 1295.0];
        console.log("precios_productos no se pasó correctamente al template");
        {% endif %}

        if (devolucionInputs.length === precios.length && entregadoInputs.length === precios.length) {
            for (let i = 0; i < precios.length; i++) {
                let devolucion = parseFloat(devolucionInputs[i].value) || 0;
                let entregado = parseFloat(entregadoInputs[i].value) || 0;

                t += entregado * precios[i];
                d += devolucion * precios[i];
            }
        } else {
            console.error("Las listas de precios y los inputs de devolución/entregado no tienen la misma longitud.");
        }

        document.getElementById("venta_total").value = t.toFixed(2);
        document.getElementById("devolucion_total").value = d.toFixed(2);
    }

    document.addEventListener("input", calculateFields);
</script>
{% endblock %}
